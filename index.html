<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mini Scrivener v2 â€“ Dropbox Enhanced</title>
  <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
  <style>
    /* é€™è£¡å®Œå…¨ä¿ç•™ä½ ä¸Šå‚³æ–‡ä»¶çš„æ‰€æœ‰ CSS æ¨£å¼ */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif; color: #222; background: #f4f5f7; }
    .app { display: flex; height: 100vh; }
    .sidebar { width: 340px; background: #111827; color: #f9fafb; display: flex; flex-direction: column; border-right: 1px solid #374151; }
    
    /* æ–°å¢ï¼šDropbox æ§åˆ¶é¢æ¿æ¨£å¼ */
    .dbx-panel { padding: 10px; background: #1f2937; border-bottom: 1px solid #374151; }
    .dbx-btn { width: 100%; padding: 6px; border-radius: 4px; border: none; font-size: 11px; font-weight: bold; cursor: pointer; margin-bottom: 4px; }
    .dbx-btn-auth { background: #2563eb; color: white; }
    .dbx-btn-release { background: #059669; color: white; display: none; }
    .dbx-status { font-size: 10px; color: #9ca3af; text-align: center; }

    /* ä»¥ä¸‹ç‚ºåŸæœ‰çš„ Sidebar æ¨£å¼ */
    .sidebar-header { padding: 8px 10px 6px; border-bottom: 1px solid #374151; display: flex; justify-content: space-between; align-items: flex-start; gap: 6px; }
    .sidebar-header-left { display: flex; flex-direction: column; gap: 4px; flex: 1; }
    .project-row { display: flex; align-items: center; gap: 4px; font-size: 11px; color: #9ca3af; }
    .project-row select { flex: 1; font-size: 11px; padding: 2px 4px; border-radius: 4px; border: 1px solid #4b5563; background: #111827; color: #e5e7eb; }
    .mode-select-row { display: flex; align-items: center; gap: 4px; font-size: 11px; color: #9ca3af; margin-top: 2px; }
    .mode-select-row select { flex: 1; font-size: 11px; background: #111827; color: #e5e7eb; border: 1px solid #4b5563; border-radius: 4px; }
    
    /* ç·¨è¼¯å™¨ã€çœ‹æ¿ç­‰å…¶é¤˜æ¨£å¼å‡ç¶­æŒåŸæ¨£ */
    .editor { flex: 1; display: flex; flex-direction: column; }
    .editor-body textarea { flex: 1; border: none; resize: none; padding: 12px 16px; font-family: monospace; font-size: 14px; background: #f3f4f6; }
    .kanban-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.8); display: none; z-index: 999; align-items: center; justify-content: center; }
    /* ... ç¯‡å¹…é—œä¿‚çœç•¥éƒ¨åˆ†é‡è¤‡ CSSï¼Œå»ºè­°ç›´æ¥åœ¨ä½ çš„åŸºç¤ä¸Šåˆä½µ ... */
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <div class="dbx-panel">
        <button id="dbx-login-btn" class="dbx-btn dbx-btn-auth" onclick="doDropboxLogin()">ğŸ”— é€£æ¥ Dropbox</button>
        <button id="dbx-release-btn" class="dbx-btn dbx-btn-release" onclick="saveOfficialVersion()">ğŸ’¾ æ‰‹å‹•å‚™ä»½æ­£å¼ç‰ˆ (Ctrl+S)</button>
        <div id="dbx-msg" class="dbx-status">æœ¬åœ°æ¨¡å¼ (æœªåŒæ­¥)</div>
      </div>

      <div class="sidebar-header">
        <div class="sidebar-header-left">
          <div class="project-row">
            <span>Project:</span>
            <select id="projectSelect"></select>
            <button class="icon-btn" id="newProjectBtn">ï¼‹</button>
          </div>
          <h1>Writing Binder</h1>
          <div class="mode-select-row">
            <span>Mode:</span>
            <select id="modeSelect">
              <option value="novel">Novel</option>
              <option value="script">Script</option>
            </select>
          </div>
          <div class="mode-select-row">
            <span>Character:</span>
            <select id="characterFilter"><option value="all">All</option></select>
          </div>
          <div class="mode-select-row">
            <span>Tag:</span>
            <select id="tagFilter"><option value="all">All</option></select>
          </div>
        </div>
        <div class="sidebar-header-right">
          <button class="btn secondary" id="addChapterBtn">+Ch</button>
          <button class="btn" id="addSceneBtn">+Sc</button>
        </div>
      </div>
      <div class="chapters-container" id="chaptersContainer"></div>
      <div class="sidebar-footer">
        <button class="btn secondary" id="quickAddCardBtn">ï¼‹ Card</button>
      </div>
    </div>

    <div class="editor">
      <div class="editor-header">
        <input id="titleInput" type="text" placeholder="Scene titleâ€¦" />
        <div class="toolbar-right">
          <button class="btn secondary" id="kanbanBtn">Board (Ctrl+B)</button>
          <button class="btn secondary" id="backupBtn">Backup</button>
        </div>
      </div>
      <div class="editor-meta">
        <div class="editor-meta-row"><label>Color</label><select id="colorSelect">...</select></div>
        <div class="editor-meta-note"><label>Note</label><textarea id="noteInput"></textarea></div>
        <div class="editor-meta-row"><label>Chars</label><input id="charsInput" type="text" /></div>
        <div class="editor-meta-row"><label>Tags</label><input id="tagsInput" type="text" /></div>
      </div>
      <div class="editor-body">
        <textarea id="textInput"></textarea>
      </div>
    </div>
  </div>

  <script>
    // --- Dropbox é…ç½® ---
    const DBX_KEY = '2zshj5fwkxe18e6';
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    const dbxAuth = new Dropbox.DropboxAuth({ clientId: DBX_KEY });
    let dbx = null;
    let autoSyncTimer = null;

    // --- é›²ç«¯åˆå§‹åŒ–é‚è¼¯ ---
    async function initCloud() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      if (code) {
        try {
          const res = await dbxAuth.getCodeChallengeResponse(code, REDIRECT_URI);
          localStorage.setItem('dbx_token', res.result.access_token);
          window.history.replaceState({}, document.title, window.location.pathname);
          enableCloud(res.result.access_token);
        } catch (e) { console.error(e); }
      } else {
        const token = localStorage.getItem('dbx_token');
        if (token) enableCloud(token);
      }
    }

    function enableCloud(token) {
      dbx = new Dropbox.Dropbox({ accessToken: token });
      document.getElementById('dbx-login-btn').style.display = 'none';
      document.getElementById('dbx-release-btn').style.display = 'block';
      document.getElementById('dbx-msg').textContent = 'âœ… é›²ç«¯å·²åŒæ­¥ (æ¯2ç§’è‡ªå‹•)';
    }

    function doDropboxLogin() {
      dbxAuth.getAuthenticationUrl(REDIRECT_URI, undefined, 'code', 'offline', undefined, undefined, true)
        .then(url => {
          window.sessionStorage.setItem('dropbox_auth_state', dbxAuth.codeVerifier);
          window.location.href = url;
        });
    }

    // è‡ªå‹•åŒæ­¥è‰ç¨¿
    async function syncDraft() {
      if (!dbx || !data) return;
      try {
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        await dbx.filesUpload({ path: '/scrivener_autosave.json', contents: blob, mode: 'overwrite' });
        document.getElementById('dbx-msg').textContent = 'âœ… é›²ç«¯åŒæ­¥å®Œæˆ ' + new Date().toLocaleTimeString();
      } catch (e) { document.getElementById('dbx-msg').textContent = 'âŒ åŒæ­¥å¤±æ•—'; }
    }

    // æ‰‹å‹•å‚™ä»½æ­£å¼ç‰ˆ
    async function saveOfficialVersion() {
      if (!dbx || !data) return;
      const time = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 16);
      try {
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        await dbx.filesUpload({ path: `/backups/release_${time}.json`, contents: blob });
        alert('æ­£å¼ç‰ˆå·²æˆåŠŸå‚™ä»½è‡³ Dropbox /backups/ è³‡æ–™å¤¾');
      } catch (e) { alert('å‚™ä»½å¤±æ•—'); }
    }

    // --- å¿«æ·éµè™•ç† ---
    document.addEventListener("keydown", e => {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      const ctrl = isMac ? e.metaKey : e.ctrlKey;

      // Ctrl + S: æ‰‹å‹•é›²ç«¯å‚™ä»½
      if (ctrl && e.key === 's') {
        e.preventDefault();
        saveOfficialVersion();
      }
      
      // å…¶é¤˜åŸæœ‰çš„å¿«æ·éµé‚è¼¯
      // Ctrl + B: çœ‹æ¿
      if (ctrl && e.key === 'b') {
        e.preventDefault();
        kanbanOverlay.style.display === "flex" ? closeKanban() : openKanban();
      }
    });

    // --- é›†æˆåˆ°åŸæœ‰ä¿å­˜é‚è¼¯ ---
    // ä¿®æ”¹ä½ çš„ saveProjectDataï¼ŒåŠ å…¥é›²ç«¯è‡ªå‹•åŒæ­¥
    function saveProjectData() {
      const pid = projectIndex.currentProjectId;
      if (!pid) return;
      localStorage.setItem(PROJECT_DATA_PREFIX + pid, JSON.stringify(data));
      
      // å»¶æ™‚åŒæ­¥
      clearTimeout(autoSyncTimer);
      autoSyncTimer = setTimeout(syncDraft, 2000);
    }

    // å•Ÿå‹•
    initCloud();
    // (æ­¤è™•ç¹¼çºŒä½ åŸæœ‰çš„æ‰€æœ‰å‡½æ•¸ï¼Œå¦‚ loadProjectData, renderChaptersAndScenes ç­‰)
  </script>
</body>
</html>

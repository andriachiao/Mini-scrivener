<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mini Scrivener v2 â€“ Cloud Enhanced</title>
  <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
  <style>
    /* é€™è£¡ä¿ç•™ä½ åŸå§‹çš„æ‰€æœ‰ CSS æ¨£å¼ */
    /* ... ç‚ºäº†ç°¡æ½”ï¼Œæˆ‘ç•¥éäº†ä½ åŸå§‹ CSS çš„é‡è¤‡éƒ¨åˆ† ... */
    
    /* é¡å¤–æ·»åŠ ï¼šDropbox å°ˆç”¨æ§åˆ¶ UI */
    .dbx-controls {
      padding: 8px 10px;
      border-bottom: 1px solid #374151;
      background: #1f2937;
    }
    .dbx-btn {
      background: #2563eb; color: white; border: none; 
      padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;
      width: 100%; margin-bottom: 5px;
    }
    .dbx-btn.release { background: #059669; }
    .dbx-status { font-size: 10px; color: #9ca3af; text-align: center; }
  </style>
</head>
<body>

  <div class="app">
    <div class="sidebar">
      <div class="dbx-controls">
        <button id="dbx-login-btn" class="dbx-btn" onclick="doDropboxLogin()">ğŸ”— é€£æ¥ Dropbox</button>
        <button id="dbx-release-btn" class="dbx-btn release" style="display:none;" onclick="saveOfficialVersion()">ğŸ’¾ ä¿å­˜æ­£å¼ç‰ˆæœ¬</button>
        <div id="dbx-msg" class="dbx-status">æœ¬åœ°æ¨¡å¼ (æœªåŒæ­¥)</div>
      </div>

      <div class="sidebar-header">
        </div>
      
      <div id="tree-container" class="tree-container">
        </div>
    </div>

    <div class="main">
      <div class="main-header">
        <input type="text" id="scene-title-input" placeholder="Scene Title..." />
        </div>
      <div id="editor" contenteditable="true"></div>
    </div>
  </div>

  <script>
    // --- æ ¸å¿ƒè®Šé‡ ---
    const CLIENT_ID = '2zshj5fwkxe18e6';
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    const dbxAuth = new Dropbox.DropboxAuth({ clientId: CLIENT_ID });
    let dbx = null;
    let autoSaveTimer = null;

    // --- 1. åˆå§‹åŒ–èˆ‡ OAuth è™•ç† ---
    async function initCloud() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');

      if (code) {
        try {
          const response = await dbxAuth.getCodeChallengeResponse(code, REDIRECT_URI);
          localStorage.setItem('dbx_access_token', response.result.access_token);
          window.history.replaceState({}, document.title, window.location.pathname);
          startDbxSession(response.result.access_token);
        } catch (e) { console.error('Dropbox Auth Error', e); }
      } else {
        const token = localStorage.getItem('dbx_access_token');
        if (token) startDbxSession(token);
      }
    }

    function startDbxSession(token) {
      dbx = new Dropbox.Dropbox({ accessToken: token });
      document.getElementById('dbx-login-btn').style.display = 'none';
      document.getElementById('dbx-release-btn').style.display = 'block';
      document.getElementById('dbx-msg').textContent = 'â˜ï¸ é›²ç«¯åŒæ­¥ä¸­';
    }

    function doDropboxLogin() {
      dbxAuth.getAuthenticationUrl(REDIRECT_URI, undefined, 'code', 'offline', undefined, undefined, true)
        .then(url => {
          window.sessionStorage.setItem('dropbox_auth_state', dbxAuth.codeVerifier);
          window.location.href = url;
        });
    }

    // --- 2. åŒæ­¥é‚è¼¯ ---

    // è‡ªå‹•åŒæ­¥ (è‰ç¨¿)
    async function autoSync() {
      if (!dbx || !currentData) return;
      document.getElementById('dbx-msg').textContent = 'â³ è‡ªå‹•ä¿å­˜ä¸­...';
      try {
        const blob = new Blob([JSON.stringify(currentData)], { type: 'application/json' });
        await dbx.filesUpload({ path: '/scrivener_autosave.json', contents: blob, mode: 'overwrite' });
        document.getElementById('dbx-msg').textContent = 'â˜ï¸ é›²ç«¯å·²åŒæ­¥';
      } catch (e) {
        document.getElementById('dbx-msg').textContent = 'âŒ åŒæ­¥å¤±æ•—';
      }
    }

    // æ‰‹å‹•æ­£å¼ç‰ˆ (å¸¶æ™‚é–“æˆ³)
    async function saveOfficialVersion() {
      if (!dbx || !currentData) return;
      const time = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 16);
      const path = `/backups/backup_${time}.json`;
      
      document.getElementById('dbx-msg').textContent = 'ğŸš€ æ­£åœ¨ä¸Šå‚³æ­£å¼ç‰ˆ...';
      try {
        const blob = new Blob([JSON.stringify(currentData)], { type: 'application/json' });
        await dbx.filesUpload({ path: path, contents: blob });
        alert('æ­£å¼ç‰ˆå·²å‚™ä»½è‡³: ' + path);
        document.getElementById('dbx-msg').textContent = 'â˜ï¸ é›²ç«¯å·²åŒæ­¥';
      } catch (e) {
        alert('æ­£å¼ç‰ˆä¿å­˜å¤±æ•—');
      }
    }

    // --- 3. é›†æˆåˆ°åŸæœ‰é‚è¼¯ ---

    // åœ¨ä½ çš„ editor input ç›£è½å™¨ä¸­èª¿ç”¨
    editor.addEventListener('input', () => {
      // ä½ åŸæœ‰çš„æœ¬åœ°ä¿å­˜é‚è¼¯
      updateSceneContent(); 
      
      // è§¸ç™¼è‡ªå‹•åŒæ­¥è¨ˆæ™‚
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(autoSync, 2000); 
    });

    // å•Ÿå‹•
    initCloud();
  </script>
</body>
</html>

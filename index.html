<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mini Scrivener v2 â€“ Dropbox Sync Edition</title>
  <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
  <style>
    /* 100% ä¿ç•™ä½ åŸå§‹çš„æ‰€æœ‰ CSS æ¨£å¼ */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      color: #222;
      background: #f4f5f7;
    }
    .app { display: flex; height: 100vh; }
    .sidebar {
      width: 340px;
      background: #111827;
      color: #f9fafb;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #374151;
    }

    /* åƒ…æ–°å¢ï¼šDropbox å°ˆç”¨æ¨£å¼ */
    .dbx-area {
      padding: 10px;
      background: #1f2937;
      border-bottom: 1px solid #374151;
    }
    .dbx-btn {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: none;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 4px;
    }
    .dbx-btn-login { background: #2563eb; color: white; }
    .dbx-btn-save { background: #059669; color: white; display: none; }
    .dbx-info { font-size: 10px; color: #9ca3af; text-align: center; margin-top: 2px; }

    /* ä»¥ä¸‹ç‚ºä½ åŸå§‹æ–‡ä»¶çš„å…¶é¤˜æ¨£å¼... (ç¯‡å¹…é—œä¿‚çœç•¥ï¼Œè«‹ä¿æŒèˆ‡åŸæ–‡ä»¶ä¸€è‡´) */
    .sidebar-header { padding: 8px 10px 6px; border-bottom: 1px solid #374151; display: flex; justify-content: space-between; align-items: flex-start; gap: 6px; }
    /* ... ä¿æŒåŸæ¨£ ... */
  </style>
</head>
<body>

  <div class="app">
    <div class="sidebar">
      <div class="dbx-area">
        <button id="dbx-login-btn" class="dbx-btn dbx-btn-login" onclick="doDropboxLogin()">ğŸ”— é€£æ¥ Dropbox</button>
        <button id="dbx-save-btn" class="dbx-btn dbx-btn-save" onclick="manualCloudBackup()">ğŸ’¾ ä¿å­˜æ­£å¼ç‰ˆ (Ctrl+S)</button>
        <div id="dbx-status" class="dbx-info">æœ¬åœ°æ¨¡å¼</div>
      </div>

      <div class="sidebar-header">
        <div class="sidebar-header-left">
          <div class="project-row">
            <span>Project:</span>
            <select id="projectSelect"></select>
            <button class="icon-btn" id="newProjectBtn">ï¼‹</button>
          </div>
          <h1>Writing Binder</h1>
          <div style="display:flex; gap:10px; margin-top:4px;">
             <div style="font-size:11px; color:#9ca3af;">Mode: <select id="modeSelect" style="background:#111827; color:#eee; border:1px solid #4b5563;"><option value="novel">Novel</option><option value="script">Script</option></select></div>
             <div style="font-size:11px; color:#9ca3af;">Char: <select id="characterFilter" style="background:#111827; color:#eee; border:1px solid #4b5563;"><option value="all">All</option></select></div>
          </div>
        </div>
        <div class="sidebar-header-right">
          <button class="btn secondary" id="addChapterBtn">+Ch</button>
          <button class="btn" id="addSceneBtn">+Sc</button>
        </div>
      </div>
      <div id="chaptersContainer" class="chapters-container"></div>
    </div>

    <div class="main">
      <div class="editor-header">
        <input id="titleInput" type="text" placeholder="Scene titleâ€¦" />
      </div>
      <div class="editor-body">
        <textarea id="textInput" placeholder="Start writing..."></textarea>
      </div>
    </div>
  </div>

  <script>
    /* --- 1. Dropbox æ ¸å¿ƒé…ç½® --- */
    const DBX_APP_KEY = '2zshj5fwkxe18e6'; 
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    const dbxAuth = new Dropbox.DropboxAuth({ clientId: DBX_APP_KEY });
    let dbx = null;
    let cloudSyncTimer = null;

    /* --- 2. é›²ç«¯æˆæ¬Šèˆ‡åˆå§‹åŒ– --- */
    async function initDropbox() {
      const urlParams = new URLSearchParams(window.location.search);
      const authCode = urlParams.get('code');

      if (authCode) {
        try {
          const res = await dbxAuth.getCodeChallengeResponse(authCode, REDIRECT_URI);
          localStorage.setItem('dbx_token', res.result.access_token);
          window.history.replaceState({}, document.title, window.location.pathname);
          startCloudSession(res.result.access_token);
        } catch (e) { console.error("Dropbox Auth Failed", e); }
      } else {
        const savedToken = localStorage.getItem('dbx_token');
        if (savedToken) startCloudSession(savedToken);
      }
    }

    function startCloudSession(token) {
      dbx = new Dropbox.Dropbox({ accessToken: token });
      document.getElementById('dbx-login-btn').style.display = 'none';
      document.getElementById('dbx-save-btn').style.display = 'block';
      document.getElementById('dbx-status').textContent = 'âœ… é›²ç«¯å·²åŒæ­¥';
    }

    function doDropboxLogin() {
      dbxAuth.getAuthenticationUrl(REDIRECT_URI, undefined, 'code', 'offline', undefined, undefined, true)
        .then(url => {
          window.sessionStorage.setItem('dropbox_auth_state', dbxAuth.codeVerifier);
          window.location.href = url;
        });
    }

    /* --- 3. åŒæ­¥å‡½æ•¸ --- */
    async function autoSyncToCloud() {
      if (!dbx || !data) return;
      document.getElementById('dbx-status').textContent = 'â³ åŒæ­¥ä¸­...';
      try {
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        await dbx.filesUpload({ path: '/mini_scrivener_autosave.json', contents: blob, mode: 'overwrite' });
        document.getElementById('dbx-status').textContent = 'âœ… é›²ç«¯å·²æ›´æ–°';
      } catch (e) { document.getElementById('dbx-status').textContent = 'âŒ åŒæ­¥å¤±æ•—'; }
    }

    async function manualCloudBackup() {
      if (!dbx || !data) return;
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 16);
      document.getElementById('dbx-status').textContent = 'ğŸš€ å‚™ä»½æ­£å¼ç‰ˆ...';
      try {
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        await dbx.filesUpload({ path: `/backups/release_${timestamp}.json`, contents: blob });
        alert('æ­£å¼ç‰ˆå‚™ä»½æˆåŠŸï¼å­˜æ”¾æ–¼ Dropbox /backups/ ç›®éŒ„');
        document.getElementById('dbx-status').textContent = 'âœ… å‚™ä»½å®Œæˆ';
      } catch (e) { alert('é›²ç«¯å‚™ä»½å¤±æ•—'); }
    }

    /* --- 4. é›†æˆåˆ°ä½ åŸæœ‰çš„é‚è¼¯ --- */

    // åœ¨ä½ åŸæœ‰çš„ saveProjectData() å‡½æ•¸æœ«å°¾åŠ å…¥è‡ªå‹•åŒæ­¥è§¸ç™¼
    // (é€™è£¡æˆ‘å‡è¨­ä½ çš„åŸæœ‰å‡½æ•¸åç‚º saveProjectData)
    const originalSaveFunction = typeof saveProjectData === 'function' ? saveProjectData : function(){};
    
    function enhancedSave() {
      // åŸ·è¡Œä½ åŸæœ¬çš„æœ¬åœ°ä¿å­˜
      // originalSaveFunction(); 

      // è§¸ç™¼é›²ç«¯è¨ˆæ™‚å™¨
      clearTimeout(cloudSyncTimer);
      cloudSyncTimer = setTimeout(autoSyncToCloud, 2000); 
    }

    // å¿«æ·éµç›£è½
    document.addEventListener('keydown', e => {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      const ctrl = isMac ? e.metaKey : e.ctrlKey;
      
      if (ctrl && e.key === 's') {
        e.preventDefault();
        manualCloudBackup();
      }
    });

    // åˆå§‹åŒ–å•Ÿå‹•
    initDropbox();
    
    /* é€™è£¡ç¹¼çºŒæ¥ä½ åŸå§‹æ–‡ä»¶çš„æ‰€æœ‰ JavaScript é‚è¼¯ (render, addScene, deleteChapter ç­‰) */
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mini Scrivener v2 â€“ Dropbox Edition</title>
  <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
  <style>
    /* é€™è£¡å®Œå…¨ä¿ç•™ä½ åŸå§‹çš„æ‰€æœ‰ CSS */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, system-ui, sans-serif; color: #222; background: #f4f5f7; }
    .app { display: flex; height: 100vh; }
    .sidebar { width: 340px; background: #111827; color: #f9fafb; display: flex; flex-direction: column; border-right: 1px solid #374151; }
    
    /* æ–°å¢ï¼šé›²ç«¯æ§åˆ¶å°æ¨£å¼ */
    .cloud-panel {
      padding: 10px; border-bottom: 1px solid #374151; background: #1f2937;
    }
    .cloud-btn {
      width: 100%; padding: 6px; border-radius: 4px; border: none; cursor: pointer;
      font-size: 11px; font-weight: bold; margin-bottom: 4px;
    }
    .btn-auth { background: #2563eb; color: white; }
    .btn-release { background: #059669; color: white; display: none; }
    .cloud-status { font-size: 10px; color: #9ca3af; text-align: center; margin-top: 4px; }

    /* ä»¥ä¸‹ç‚ºä½ åŸå§‹ä»‹é¢çš„å…¶é¤˜æ¨£å¼ (çœç•¥éƒ¨åˆ†ä»¥ç¯€çœç¯‡å¹…ï¼Œè«‹ä¿ç•™ä½ åŸæœ‰çš„) */
    .sidebar-header { padding: 8px 10px 6px; border-bottom: 1px solid #374151; display: flex; justify-content: space-between; align-items: flex-start; gap: 6px; }
    .tree-container { flex: 1; overflow-y: auto; padding: 10px; }
    .main { flex: 1; display: flex; flex-direction: column; background: #fff; }
    #editor { flex: 1; padding: 40px; font-size: 18px; line-height: 1.6; outline: none; overflow-y: auto; }
    #scene-title-input { width: 100%; border: none; font-size: 24px; font-weight: bold; padding: 20px 40px; outline: none; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>

  <div class="app">
    <div class="sidebar">
      <div class="cloud-panel">
        <button id="dbx-login-btn" class="cloud-btn btn-auth" onclick="doDropboxLogin()">ğŸ”— é€£æ¥ Dropbox</button>
        <button id="dbx-release-btn" class="cloud-btn btn-release" onclick="saveOfficialVersion()">ğŸ’¾ ä¿å­˜æ­£å¼ç‰ˆæœ¬</button>
        <div id="dbx-msg" class="cloud-status">æœ¬åœ°æ¨¡å¼ (æœªåŒæ­¥)</div>
      </div>

      <div class="sidebar-header">
        <div class="sidebar-header-left">
          <select id="project-select" style="width:100%; font-size:11px;"></select>
          <div style="display:flex; gap:4px;">
            <button onclick="addProject()" title="New Project" style="flex:1;">+P</button>
            <button onclick="renameProject()" title="Rename" style="flex:1;">âœï¸</button>
            <button onclick="deleteProject()" title="Delete" style="flex:1;">ğŸ—‘ï¸</button>
          </div>
        </div>
        <div style="display:flex; flex-direction:column; gap:4px;">
          <button onclick="addChapter()">+ Chapter</button>
          <button onclick="addScene()">+ Scene</button>
        </div>
      </div>
      
      <div id="tree-container" class="tree-container"></div>
    </div>

    <div class="main">
      <input type="text" id="scene-title-input" placeholder="Scene Title..." />
      <div id="editor" contenteditable="true"></div>
    </div>
  </div>

  <script>
    // --- 1. æ ¸å¿ƒè®Šé‡èˆ‡ Dropbox é…ç½® ---
    const CLIENT_ID = '2zshj5fwkxe18e6';
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    const dbxAuth = new Dropbox.DropboxAuth({ clientId: CLIENT_ID });
    let dbx = null;
    let autoSyncTimer = null;

    // --- 2. é›²ç«¯åŒæ­¥é‚è¼¯ ---
    async function initCloud() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      if (code) {
        try {
          const res = await dbxAuth.getCodeChallengeResponse(code, REDIRECT_URI);
          localStorage.setItem('dbx_token', res.result.access_token);
          window.history.replaceState({}, document.title, window.location.pathname);
          enableCloud(res.result.access_token);
        } catch (e) { console.error(e); }
      } else {
        const token = localStorage.getItem('dbx_token');
        if (token) enableCloud(token);
      }
    }

    function enableCloud(token) {
      dbx = new Dropbox.Dropbox({ accessToken: token });
      document.getElementById('dbx-login-btn').style.display = 'none';
      document.getElementById('dbx-release-btn').style.display = 'block';
      document.getElementById('dbx-msg').textContent = 'â˜ï¸ é›²ç«¯åŒæ­¥å·²é–‹å•Ÿ';
      // é¦–æ¬¡åŠ è¼‰å¯å˜—è©¦å¾é›²ç«¯æ‹‰å–
      checkCloudFirstTime();
    }

    function doDropboxLogin() {
      dbxAuth.getAuthenticationUrl(REDIRECT_URI, undefined, 'code', 'offline', undefined, undefined, true)
        .then(url => {
          window.sessionStorage.setItem('dropbox_auth_state', dbxAuth.codeVerifier);
          window.location.href = url;
        });
    }

    async function syncDraft() {
      if (!dbx || !currentData) return;
      document.getElementById('dbx-msg').textContent = 'â³ è‡ªå‹•ä¿å­˜ä¸­...';
      try {
        const blob = new Blob([JSON.stringify(currentData)], { type: 'application/json' });
        await dbx.filesUpload({ path: '/scrivener_autosave.json', contents: blob, mode: 'overwrite' });
        document.getElementById('dbx-msg').textContent = 'â˜ï¸ é›²ç«¯å·²åŒæ­¥';
      } catch (e) { document.getElementById('dbx-msg').textContent = 'âŒ åŒæ­¥å¤±æ•—'; }
    }

    async function saveOfficialVersion() {
      if (!dbx || !currentData) return;
      const time = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 16);
      try {
        const blob = new Blob([JSON.stringify(currentData)], { type: 'application/json' });
        await dbx.filesUpload({ path: `/backups/release_${time}.json`, contents: blob });
        alert('æ­£å¼ç‰ˆå‚™ä»½æˆåŠŸï¼');
      } catch (e) { alert('å‚™ä»½å¤±æ•—'); }
    }

    // --- 3. ç¹¼æ‰¿åŸæœ‰é‚è¼¯ (é€™è£¡éœ€è¦åˆä½µä½ åŸå§‹çš„å…§å®¹ç®¡ç†å‡½æ•¸) ---
    // å‡è¨­ä½ åŸå§‹çš„ä»£ç¢¼ä¸­å·²ç¶“å®šç¾©äº† currentData, loadProjectData ç­‰
    
    // ä¿®æ”¹åŸæœ‰çš„ saveProjectData
    const originalSaveProjectData = (data) => {
        if (!data) return;
        localStorage.setItem('scrivener_data_' + data.id, JSON.stringify(data));
        
        // è§¸ç™¼é›²ç«¯è‡ªå‹•åŒæ­¥
        clearTimeout(autoSyncTimer);
        autoSyncTimer = setTimeout(syncDraft, 2000);
    };

    // ç›£è½ç·¨è¼¯å™¨è¼¸å…¥
    document.getElementById('editor').addEventListener('input', () => {
        // ... ä½ åŸæœ¬çš„æ›´æ–°é‚è¼¯ ...
        // updateSceneContent(); 
        originalSaveProjectData(currentData);
    });

    // é é¢åŠ è¼‰å•Ÿå‹•
    initCloud();
  </script>
</body>
</html>
